# Complete GHL Contact Form Mapping - VERIFIED AGAINST ACTUAL GHL

## ðŸŽ¯ Based on Actual GHL Contact Structure

From examining real GHL contacts, here are **ALL** the fields GHL stores:

---

## âœ… GHL NATIVE CONTACT FIELDS (Standard API Fields)

### Identity Fields
| GHL Field | GMH Source | Transform/Clean | Required? | Notes |
|-----------|------------|-----------------|-----------|-------|
| `firstName` | `full_name` (first word) | stripTitles() â†’ titleCase() | âœ… YES | "Rick" from "Rick Murphy Jr" |
| `lastName` | `full_name` (rest) | stripTitles() â†’ titleCase() + suffix | âŒ No | "Murphy Jr" from "Rick Murphy Jr" |
| `name` | `full_name` | titleCase() | âŒ No | Full name as-is |
| `email` | `email` | trim() â†’ toLowerCase() | âš ï¸ YES* | *Or phone required |
| `phone` | `phone_primary` | normalizePhone() â†’ E.164 | âš ï¸ YES* | *Or email required |

### Auto-Generated by GHL (Read-Only)
| GHL Field | Description |
|-----------|-------------|
| `firstNameLowerCase` | Auto-generated by GHL |
| `lastNameLowerCase` | Auto-generated by GHL |
| `fullNameLowerCase` | Auto-generated by GHL |
| `emailLowerCase` | Auto-generated by GHL |

### Address Fields
| GHL Field | GMH Source | Transform/Clean | Notes |
|-----------|------------|-----------------|-------|
| `address1` | `address_line1` | trim() â†’ titleCase() | "240 S Penn Avenue" |
| `city` | `city` | trim() â†’ titleCase() | "Prescott" not "prescott" |
| `state` | `state` | validateState() â†’ uppercase | Must be 2-letter: "AZ" |
| `postalCode` | `postal_code` | validateZip() â†’ 5-digit | "86303" (detect swapped state/ZIP) |
| `country` | Always "US" | Fixed value | **Required** by GHL |

### Dates
| GHL Field | GMH Source | Format | Notes |
|-----------|------------|--------|-------|
| `dateOfBirth` | `date_of_birth` | ISO: "YYYY-MM-DD" | "1969-03-20" |

### System Fields
| GHL Field | GMH Value | Notes |
|-----------|-----------|-------|
| `source` | "GMH Dashboard" | Track where contact came from |
| `type` | "lead" or "contact" | Default to "lead" |
| `locationId` | "0dpAFAovcFXbe0G5TUFr" | Your GHL location ID |

### Additional Fields
| GHL Field | GMH Source | Notes |
|-----------|------------|-------|
| `additionalPhones` | Array | Empty for now (could add alt phones) |
| `companyName` | null | Not used for patients |
| `website` | null | Not used for patients |

---

## ðŸ·ï¸ GHL TAGS (Applied via API)

Tags are managed separately, NOT in customFields:

```javascript
// Tags applied based on conditions
tags: [
  "GMH Patient",          // Always
  "existing",             // If mens health client type
  "Active Patient",       // If status = active
  "PrimeCare Patient",    // If is_primary_care = true
  "Labs Overdue",         // If lab_status contains "overdue"
  // etc...
]
```

**Special Rule:** If `status_key === 'inactive'` â†’ **Remove ALL tags**

---

## ðŸ“‹ GHL CUSTOM FIELDS (Extended Data)

Custom fields in GHL use ID-based keys. We need to create these in GHL first, then use their IDs:

### Clinical & Status
| Display Name | GMH Source | Format | Purpose |
|--------------|------------|--------|---------|
| Patient Status | `alert_status` | Text | "Active", "Inactive", etc. |
| Patient Status Key | `status_key` | Text | "active", "inactive", etc. |
| Client Type | `type_of_client` | Text | "QBO TCMH $180/Month", etc. |
| Client Type Key | `client_type_key` | Text | "qbo_tcmh_180_month" |
| Payment Method | `method_of_payment` | Text | "Jane", "QBO", etc. |
| Is Primary Care | `is_primary_care` | Boolean | true/false |
| Regimen | `regimen` | Text | Treatment regimen |
| Lab Status | `lab_status` | Text | Lab work status |

### Dates & Tracking
| Display Name | GMH Source | Format | Purpose |
|--------------|------------|--------|---------|
| Service Start Date | `service_start_date` | ISO Date | When service began |
| Contract End Date | `contract_end` | ISO Date | Contract expiration |
| Last Lab Date | `last_lab` | ISO Date | Most recent lab |
| Next Lab Date | `next_lab` | ISO Date | Upcoming lab |
| Last Supply Date | `last_supply_date` | ISO Date | Last supply provided |
| Eligible for Next Supply | `eligible_for_next_supply` | ISO Date | Next eligibility date |
| Last DEA Dispense | `last_controlled_dispense_at` | ISO Date | Last controlled substance |
| GMH Date Added | `date_added` | ISO Date | Added to GMH system |
| GMH Last Modified | `last_modified` | ISO Date | Last update in GMH |

### Membership & Financial
| Display Name | GMH Source | Format | Purpose |
|--------------|------------|--------|---------|
| Membership Program | `membership_program` | Text | Program name |
| Membership Status | `membership_status` | Text | Active, Inactive, etc. |
| Membership Balance | `membership_owes` / `membership_balance` | Currency | Amount owed |
| Next Charge Date | `next_charge_date` | ISO Date | Upcoming payment |
| Last Charge Date | `last_charge_date` | ISO Date | Last payment |
| Regular Client | `regular_client` | Boolean | Loyalty flag |
| Verified Patient | `is_verified` | Boolean | Verification status |
| Supply Status | `supply_status` | Text | Supply fulfillment status |
| Last DEA Drug | `last_dea_drug` | Text | Drug name |

---

## ðŸ”§ NAME FORMATTING RULES

### Problem: Simple Split Fails for Complex Names

**Current naive approach:**
```javascript
firstName = "Rick Murphy Jr".split(' ')[0]  // "Rick" âœ…
lastName = "Rick Murphy Jr".split(' ').slice(1).join(' ')  // "Murphy Jr" âœ…
```

**Issues to handle:**
1. Titles: "Mr. John Smith", "Dr. Jane Doe", "Mrs. Susan Jones"
2. Suffixes: "Rick Murphy Jr", "Rick Murphy Sr", "John Smith III"
3. Hyphenated: "Mary-Jane Watson", "Jean-Claude Van Damme"
4. Single names: "Cher", "Madonna" (rare but possible)
5. Multiple middle: "John Robert William Smith"

### âœ… Correct Name Parsing Function

```javascript
function parseFullName(fullName) {
  if (!fullName || !fullName.trim()) {
    return { firstName: '', lastName: '', fullName: '' };
  }
  
  // Clean and trim
  let name = fullName.trim();
  
  // Remove common titles (case-insensitive)
  const titles = ['Mr.', 'Mrs.', 'Ms.', 'Dr.', 'Miss', 'Rev.', 'Prof.'];
  for (const title of titles) {
    const regex = new RegExp(`^${title}\\s+`, 'i');
    name = name.replace(regex, '');
  }
  
  // Split into parts
  const parts = name.split(/\s+/).filter(p => p.length > 0);
  
  if (parts.length === 0) {
    return { firstName: '', lastName: '', fullName: fullName };
  }
  
  if (parts.length === 1) {
    // Single name
    return {
      firstName: toTitleCase(parts[0]),
      lastName: '',
      fullName: toTitleCase(parts[0])
    };
  }
  
  // First name is always first part
  const firstName = toTitleCase(parts[0]);
  
  // Last name is everything else (includes Jr, Sr, middle names)
  const lastName = parts.slice(1).map(p => toTitleCase(p)).join(' ');
  
  return {
    firstName,
    lastName,
    fullName: `${firstName} ${lastName}`
  };
}

function toTitleCase(str) {
  // Handle special cases like McCartney, LaVella
  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}
```

### Examples:
| Input | firstName | lastName | fullName |
|-------|-----------|----------|----------|
| "Rick Murphy Jr" | "Rick" | "Murphy Jr" | "Rick Murphy Jr" |
| "Mr. John Smith" | "John" | "Smith" | "John Smith" |
| "Tom LaVella" | "Tom" | "Lavella" | "Tom Lavella" |
| "JOHN SMITH" | "John" | "Smith" | "John Smith" |
| "john smith" | "John" | "Smith" | "John Smith" |

---

## ðŸ”§ PHONE NUMBER FORMATTING

### GHL Requires: E.164 Format

```javascript
function normalizePhone(phone) {
  if (!phone) return null;
  
  // Remove all non-digits
  const digits = phone.replace(/\D/g, '');
  
  // No digits = invalid
  if (digits.length === 0) return null;
  
  // If 10 digits, assume US and prefix +1
  if (digits.length === 10) {
    return `+1${digits}`;
  }
  
  // If 11 digits starting with 1, prefix +
  if (digits.length === 11 && digits[0] === '1') {
    return `+${digits}`;
  }
  
  // If already starts with +, keep as-is
  if (phone.trim().startsWith('+')) {
    return `+${digits}`;
  }
  
  // Invalid format
  if (digits.length < 10) return null;
  
  // Default: assume US
  return `+1${digits.slice(-10)}`;
}
```

### Examples:
| Input | Output |
|-------|--------|
| "(928) 963-2255" | "+19289632255" |
| "928-963-2255" | "+19289632255" |
| "+16024810656" | "+16024810656" |
| "9289632255" | "+19289632255" |

---

## ðŸ”§ ADDRESS CLEANING

```javascript
function cleanAddress(patient) {
  let { address_line1, city, state, postal_code } = patient;
  
  // Clean address
  address_line1 = titleCase(trim(address_line1));
  city = titleCase(trim(city));
  
  // Clean state
  state = trim(state).toUpperCase();
  postal_code = trim(postal_code);
  
  // Check if state/ZIP are swapped
  if (state.length === 5 && /^\d{5}$/.test(state)) {
    // State has ZIP code!
    const temp = state;
    state = postal_code && postal_code.length === 2 ? postal_code : 'AZ';
    postal_code = temp;
  }
  
  // Validate state
  if (state.length !== 2) {
    state = 'AZ';  // Default to Arizona
  }
  
  // Clean postal
  postal_code = postal_code ? postal_code.replace(/\D/g, '').slice(0, 5) : null;
  
  return {
    address1: address_line1,
    city,
    state,
    postalCode: postal_code,
    country: 'US'
  };
}
```

---

## ðŸ“‹ COMPLETE SYNC FLOW

```javascript
1. Parse name â†’ firstName, lastName
2. Normalize phone â†’ E.164 format
3. Clean address â†’ title case, validate state/ZIP
4. Format dates â†’ ISO format
5. Calculate tags based on status
6. If inactive â†’ remove ALL tags
7. Map custom fields
8. Update GHL contact
9. Update tags separately
10. Log sync status
```

---

## âš ï¸ CRITICAL REQUIREMENTS FOR GHL

âœ… **At least ONE required:** firstName OR email OR phone  
âœ… **Country:** Must include "US" for addresses  
âœ… **Phone:** Must be E.164 format (+1XXXXXXXXXX)  
âœ… **State:** Must be 2-letter code  
âœ… **Tags:** Applied separately, not in custom fields  
âœ… **Custom Field IDs:** Must use GHL's actual field IDs (need to create first)  

---

## ðŸš€ BEFORE WE SYNC - NEED TO:

1. âœ… Update sync code with proper name parsing
2. âœ… Add phone normalization
3. âœ… Add address cleaning with state/ZIP detection  
4. âœ… Add country field ("US")
5. âœ… Add all custom fields (21 fields)
6. âœ… Implement inactive â†’ remove all tags logic
7. âš ï¸ **Create custom fields in GHL UI first** (get their IDs)
8. âœ… Test with 1 patient
9. âœ… Bulk sync

---

**Ready for me to update the sync code with all these corrections?**
