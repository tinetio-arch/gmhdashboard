#!/usr/bin/env tsx
/**
 * Test Headless API Vulnerability
 * 
 * Tests if the headless app endpoints are accessible 
 * using the Healthie ID of a revoked user.
 */

import dotenv from 'dotenv';
dotenv.config({ path: '/home/ec2-user/.env' });
dotenv.config({ path: '.env.local' });

// We'll use localhost since we're on the server
const BASE_URL = 'http://localhost:3000'; // Assuming app runs on 3000

// Revoked User: Phillip Schafer
const REVOKED_HEALTHIE_ID = '12123979';

async function main() {
    console.log(`\nüîì Testing Headless API Vulnerability`);
    console.log(`   Target Healthie ID: ${REVOKED_HEALTHIE_ID} (REVOKED)`);

    // We need to run this against the actual running app.
    // Since we're in a dev environment, we might need to invoke the route handler function directly
    // or use a mock request if the server isn't running on port 3000.

    // Let's try to import the GET handler directly from the route file!
    // This avoids network issues.

    try {
        const { GET } = await import('../app/api/headless/lab-status/route');

        // Create a mock NextRequest
        const { NextRequest } = await import('next/server');
        const url = `http://localhost/api/headless/lab-status?healthie_id=${REVOKED_HEALTHIE_ID}`;
        const req = new NextRequest(url);

        console.log(`\n1Ô∏è‚É£  Testing /api/headless/lab-status...`);

        const response = await GET(req);
        const data = await response.json();

        console.log(`   Status: ${response.status}`);
        console.log(`   Response:`, JSON.stringify(data, null, 2));

        if (response.status === 200 && !data.error) {
            console.log(`\nüö® VULNERABILITY CONFIRMED!`);
            console.log(`   Endpoint returned data for a REVOKED user.`);
            console.log(`   The headless app bypasses access control by hitting this API directly.`);
        } else {
            console.log(`\n‚úÖ Access Denied (or other error).`);
        }

    } catch (err) {
        console.error('Error running test:', err);
    }
}

main().catch(console.error);
